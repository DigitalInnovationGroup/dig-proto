# dig-proto

Protocol Buffer definitions for Dig project.

Shared protobuf library for Rust and Dart/Flutter applications.

## âœ¨ Features

- ğŸ¦€ **Rust Support** - Generated with `prost`, includes derive macros
- ğŸ¯ **Dart/Flutter Support** - Generated with `protoc-gen-dart`
- ğŸ”„ **Auto-generation** - Single `build.sh` script for both languages
- ğŸ› ï¸ **Custom Extensions** - Add your own implementations in `rust/ext/`
- ğŸŒ **FromRequest Macro** - Automatic HTTP request body decoding for all proto types
- ğŸ“¦ **Type-safe** - Full type safety across Rust and Dart

## ğŸš€ Quick Start

```bash
./build.sh
```

This will:
- Clean previous generated files (preserving `rust/mod.rs`)
- Compile `.proto` files to Rust using `prost` (via `build.rs`)
- Compile `.proto` files to Dart using `protoc-gen-dart`

## ğŸ“‹ Prerequisites

### Required

1. **Protocol Buffer Compiler**
   ```bash
   brew install protobuf
   ```

2. **Rust toolchain**
   ```bash
   curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
   ```

3. **Dart plugin for protoc**
   ```bash
   dart pub global activate protoc_plugin
   export PATH="$PATH:$HOME/.pub-cache/bin"
   ```

### Optional (for development)

- **protoc-gen-prost** - not needed, `prost-build` is used via `build.rs`

## ğŸ“ Project Structure

```
dig-proto/
â”œâ”€â”€ proto/              # Source .proto files
â”œâ”€â”€ rust/               # Rust library
â”‚   â”œâ”€â”€ mod.rs          # Main module (manual)
â”‚   â”œâ”€â”€ proto/          # Generated Rust code (auto-generated)
â”‚   â”‚   â”œâ”€â”€ mod.rs      # Auto-generated module exports
â”‚   â”‚   â”œâ”€â”€ user.rs
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ext/            # Custom extensions (manual)
â”‚       â”œâ”€â”€ mod.rs      # Extension module exports
â”‚       â””â”€â”€ README.md   # Extension guidelines
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ dig_proto.dart    # Main Dart library
â”‚   â””â”€â”€ src/                # Generated Dart code
â”‚       â”œâ”€â”€ user.pb.dart
â”‚       â””â”€â”€ ...
â”œâ”€â”€ build.rs            # Rust build script (auto-generates Rust code)
â”œâ”€â”€ build.sh            # Build script for both Rust and Dart
â””â”€â”€ Cargo.toml
```

**Key directories:**
- `proto/` - Source of truth (`.proto` files)
- `rust/proto/` - **DO NOT EDIT** (auto-generated by `build.rs`)
- `rust/ext/` - Add your custom implementations here
- `lib/src/` - **DO NOT EDIT** (auto-generated by `protoc`)

## ğŸ¦€ Usage in Rust

### Add dependency

In your `Cargo.toml`:

```toml
[dependencies]
dig-proto = { path = "../dig-proto" }
prost = "0.14.3"
serde = { version = "1.0", features = ["derive"] }
```

### Basic Example

```rust
use dig_proto::proto::user::User;
use prost::Message;

fn main() {
    let user = User {
        id: "user-id".to_string(),
        name: "John Doe".to_string(),
        avatar: "avatar-url".to_string(),
    };
    
    // Encode to bytes
    let bytes = user.encode_to_vec();
    
    // Decode from bytes
    let decoded = User::decode(&bytes[..]).unwrap();
    
    println!("{:?}", decoded);
}
```

### Using FromRequest

All generated protobuf types automatically implement `from_request` method:

```rust
use dig_proto::proto::user::User;
use http::Request;
use hyper::body::Incoming;

async fn handler(request: Request<Incoming>) -> Result<(), Box<dyn std::error::Error>> {
    // Decode protobuf message directly from HTTP request body
    let user = User::from_request(request).await?;
    
    println!("User: {} {}", user.id, user.name);
    Ok(())
}
```

### Custom Extensions

You can add custom methods to generated types in `rust/ext/`:

```rust
// rust/ext/user.rs
use crate::proto::user::User;

impl User {
    pub fn display_name(&self) -> String {
        if self.name.is_empty() {
            self.id.clone()
        } else {
            self.name.clone()
        }
    }
}
```

## ğŸ¯ Usage in Flutter/Dart

### Add dependency

In your `pubspec.yaml`:

```yaml
dependencies:
  dig_proto:
    path: ../dig-proto
```

### Get dependencies

```bash
flutter pub get
# or
dart pub get
```

### Example

```dart
import 'package:dig_proto/dig_proto.dart';

void main() {
  final user = User()
    ..id = 'user-id'
    ..name = 'John Doe'
    ..avatar = 'avatar-url';
  
  // Serialize to bytes
  final bytes = user.writeToBuffer();
  
  // Deserialize from bytes
  final user2 = User.fromBuffer(bytes);
  
  print('User: ${user2.name}');
}
```

## ğŸ”§ Development

### Modify proto files

1. Edit files in `proto/` directory
2. Run `./build.sh` to regenerate Rust and Dart code
3. Commit both `.proto` files and generated code

### Build system

- **Rust**: Uses `prost-build` in `build.rs` to auto-generate code during `cargo build`
- **Dart**: Uses `protoc` with `protoc-gen-dart` plugin
- **Auto-generated exports**: `rust/proto/mod.rs` is automatically created listing all modules

### Clean build

The `build.sh` script automatically cleans previous generated files:

```bash
# Removes all .rs files from rust/proto/ and creates placeholder mod.rs
# Removes all .dart files from lib/src/

./build.sh
```

For manual cleaning:

```bash
# Clean Rust generated code (keeps rust/ext/)
find rust/proto -name "*.rs" -type f -delete

# Clean Dart generated code
rm -rf lib/src/*.dart

# Clean build artifacts
cargo clean
```

**Note:** Never delete `rust/ext/` - that's where your custom code lives!

## ğŸ“¦ Output

After running `./build.sh`:

- **Rust**: `rust/proto/` directory (`.rs` files + `mod.rs`)
  - Generated by `prost-build` via `build.rs`
  - Auto-generated `mod.rs` with all module exports
- **Dart**: `lib/src/` directory (`.dart` files)
  - Generated by `protoc` with `protoc-gen-dart` plugin
  - `.pb.dart`, `.pbenum.dart`, `.pbjson.dart` files

## âš¡ Features

- âœ… Automatic code generation for Rust (prost) and Dart
- âœ… Serde support for Rust types
- âœ… Auto-generated module exports (`rust/proto/mod.rs`)
- âœ… Clean build with preservation of custom extensions (`rust/ext/`)
- âœ… Single build script for both platforms
- âœ… Separation of generated code and custom implementations
- âœ… Easy to extend with custom methods via `impl` blocks

## ğŸ“„ License

MIT
